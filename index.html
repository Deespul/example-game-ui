<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clickbait</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.7/signalr.min.js"></script>
  <script src="./env.js"></script>
  <script>
    $(document).ready(() => {
      const apiurl = config.API_URL
      const matchboxurl = config.MATCHBOX_API
      let clickCounter = 0
      let gameStart
      let loggedInPlayer = null
      let usedQueue = null
      let players = []
      let matchId = ''

      const gameFound = $("#game-found");
      const searchField = $("#search-field");
      const searchButton = $("#search-button");
      const startGameButton = $("#start-game");
      const onlinePlayerList = $("#online-player-list");
      const game = $("#game");
      const clickTarget = $("#click-target");
      const waitingForGameEnd = $("#waiting-for-game-end");
      const playerSelectList = $("#player-select-list");
      const onlinePlayers = $('#online-players');
      const queueSelectList = $('#queue-select-list');
      const gameResult = $('#game-result');

      const connection = new signalR.HubConnectionBuilder()
        .withUrl(`${apiurl}/gamehub`)
        .build();

      connection.on('PlayerEntered', (player) => addPlayerToList(player));
      connection.on('PlayerLeft', (player) => {
        $(`#${player.playerId}`).remove()
      })

      connection.on('MatchFinished', (result) => {
        console.log('match finished')
        searchButton.show()
        gameResult.empty();
        onlinePlayerList.show();
        waitingForGameEnd.hide()

        const vsSlot = $('<div>')
        vsSlot.text("Game Result:")
        gameResult.append(vsSlot)

        const winnerDiv = $('<div>')
        const winnerTeam = result.teamsAfterMmrUpdate.find(t => t.playerIds[0].playerId === result.winner)
        const winnerPlayer = players.find(p => p.playerId === winnerTeam.playerIds[0].playerId)
        winnerDiv.text(`Winner: ${winnerPlayer.playerId} (${Math.round(winnerTeam.mmr.rating)} MMR)`)
        gameResult.append(winnerDiv)

        const looserDiv = $('<div>')
        const looserTeam = result.teamsAfterMmrUpdate.find(t => t.playerIds[0].playerId !== result.winner)
        const looserPlayer = players.find(p => p.playerId === looserTeam.playerIds[0].playerId)
        looserDiv.text(`Looser: ${looserPlayer.playerId} (${Math.round(looserTeam.mmr.rating)} MMR)`)
        gameResult.append(looserDiv)
        gameResult.show()
      });

      connection.on('PartialResultReported', () => {
        console.log('match partially reported')
        waitingForGameEnd.show()
      });

      connection.on('MatchReportFailed', () => {
        console.log('match report failed')
        searchButton.show()
        startGameButton.hide()
      });

      connection.on('Enqueued', () => {
        console.log('enqueued')
        searchField.show()
      });
      connection.on('EnqueueFailed', () => {
        console.log('enqueue failed')
        searchButton.show()
        searchField.hide()
      })
      connection.on('MatchFound', (res) => {
        console.log('match found')
        matchId = res.matchId

        const player1Slot = $('<div>')
        let team1 = res.teams[0];
        let playerId1 = team1.playerIds[0];
        const player1 = players.find(p => p.playerId === playerId1.playerId)
        player1Slot.text(`${player1.playerId} (${Math.round(team1.mmr.rating)} MMR)`)
        gameFound.append(player1Slot)
        const vsSlot = $('<div>')
        vsSlot.text("VS")
        gameFound.append(vsSlot)

        const player2Slot = $('<div>')
        let team2 = res.teams[1];
        let playerId2 = team2.playerIds[0];
        const player2 = players.find(p => p.playerId === playerId2.playerId)
        player2Slot.text(`${player2.playerId} (${Math.round(team2.mmr.rating)} MMR)`)
        gameFound.append(player2Slot)

        gameFound.show()
        startGameButton.show()
        onlinePlayerList.hide()
        searchField.hide()
      });
      connection.on('LoggedIn', (res) => {
        searchButton.show()
        res.onlinePlayers.forEach(p => {
          addPlayerToList(p);
        })
      });

      connection.start().then(() => {
        searchButton.click(() => {
          searchButton.hide()
          gameResult.hide()
          waitingForGameEnd.hide()
          onlinePlayerList.hide()

          connection.invoke(
            'Enqueue',
            {
              queueId: usedQueue.queueId,
              playerIds: [{playerId: loggedInPlayer.playerId}]
            },
          );
        })

        clickTarget.click(() => {
          moveClickTargetToRandomPlace();
          clickCounter++

          if (clickCounter >= 3) {
            clickCounter = 0;
            clickTarget.hide()

            const gameEnd = performance.now()
            const diff = gameEnd - gameStart

            connection.invoke('ReportGame', diff, matchId)
            matchId = ''
          }
        })

        startGameButton.click(() => {
          startGameButton.hide()
          gameFound.empty()
          gameFound.hide()
          clickTarget.show()
          gameStart = performance.now()

          moveClickTargetToRandomPlace();
        })
      })

      axios.get(`${matchboxurl}/players?api_key=secret`)
        .then((r => {
          players = r.data
          players.forEach(p => {
            const playerSlot = $('<div>')
            playerSlot.text(`${p.playerId}`)
            playerSlot.attr("id", "select-player-" + p.playerId)
            playerSlot.addClass('player-list-item')
            playerSlot.click((e) => {
              const realPlayerId = e.target.id.replace("select-player-", "");
              loggedInPlayer = {
                playerId: realPlayerId,
                playerId: e.target.innerText,
              }
              logInPlayer(p)
              connection.invoke('LoginAs', loggedInPlayer)
            })
            playerSelectList.append(playerSlot)
          })
        }))

      axios.get(`${matchboxurl}/queues?api_key=secret`)
        .then((r => {
          const queues = r.data
          queues.forEach(p => {
            const queueSlot = $('<div>')
            queueSlot.text(`${p.name}`)
            queueSlot.attr("id", p.queueId)
            queueSlot.addClass('player-list-item')
            queueSlot.click((e) => {
              usedQueue = {
                queueId: e.target.id,
                name: e.target.innerText,
              }
              queueSelectList.hide()
              playerSelectList.show()
            })
            queueSelectList.append(queueSlot)
          })
        }))

      function addPlayerToList(p) {
        const playerSlot = $('<div>')
        playerSlot.text(`${p.playerId}`)
        playerSlot.attr("id", p.playerId)
        playerSlot.addClass('player-list-item')
        onlinePlayers.append(playerSlot)
      }

      function logInPlayer() {
        game.show()
        playerSelectList.hide()
        onlinePlayerList.show()
      }

      function moveClickTargetToRandomPlace() {
        const width = window.innerWidth - 100
        const height = window.innerHeight - 60
        clickTarget.css({
          left: Math.random() * width,
          top:Math.random() * height
        });
      }
    })
  </script>
  <style>
    body {
      font-family: Tahoma, sans-serif;
    }

    .primary-button {
      border-radius: 4px;
      padding: 10px 20px 10px 20px;
      border: 1px solid darkgray;
      background-color: lightgray;
      margin: 20px;
    }

    #game {
      width: 100%;
      text-align: center;
      display: flex;
      justify-content: center;
    }

    #game-found {
      margin-top: 20px;
      margin-bottom: 20px;
    }

    #game-found-header {
      margin-bottom: 10px;
    }

    #click-target {
      position: absolute;
      z-index: 5000;
    }

    .player-list-item {
      border-top: 1px solid darkgray;
      padding: 10px 20px 10px 20px;
    }

    .player-list-item:nth-child(1) {
      border-top: none;
      margin-top: 20px;
    }

  </style>
</head>
<body>
  <div id="click-target" class="primary-button" hidden>
    Click me!
  </div>
  <div id="game" hidden>
    </div>
    <div id="search-button" class="primary-button" hidden>
      Search Game
    </div>
    <div id="start-game" class="primary-button" hidden>
      Start Game
    </div>
    <div id="game-result" hidden>
    </div>
    <div id="search-field" hidden>
      Searching Opponent...
    </div>
    <div id="waiting-for-game-end" hidden>
      Waiting for Opponent...
    </div>
    <div id="game-found" hidden>
      <div id="game-found-header">Found Game:</div>
    </div>
    <div id="online-player-list" hidden>
      <div>Players online:</div>
      <div id="online-players"></div>
    </div>
  </div>
  <div id="player-select-list" hidden>
    <div>Select Player</div>
  </div>
  <div id="queue-select-list">
    <div>Select Queue</div>
  </div>
</body>
</html>
