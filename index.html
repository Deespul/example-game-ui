<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clickbait</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.7/signalr.min.js"></script>
  <script src="./env.js"></script>
  <script>
    const apiurl = config.API_URL
    const matchboxurl = config.MATCHBOX_API
    let clickCounter = 0
    let gameStart

    function addPlayerToList(p) {
      const playerSlot = $('<div>')
      playerSlot.text(`${p.externalPlayerId}`)
      playerSlot.attr("id", p.playerId)
      playerSlot.addClass('player-list-item')
      $('#online-players').append(playerSlot)
    }

    function logInPlayer(loggedInPlayer) {
      $("#game").show()
      $("#player-select-list").hide()
      $("#player-name").text(`logged in as: ${loggedInPlayer.externalPlayerId}`)
    }

    function moveClickTargetToRandomPlace() {
      const width = window.innerWidth - 100
      const height = window.innerHeight - 60
      $("#click-target").css({
        left: Math.random() * width,
        top:Math.random() * height
      });
    }

    $(document).ready(() => {
      let loggedInPlayer = JSON.parse(localStorage.getItem("player"))
      let players = []

      if (loggedInPlayer) {
        logInPlayer(loggedInPlayer);
      }

      const connection = new signalR.HubConnectionBuilder()
        .withUrl(`${apiurl}/gamehub`)
        .build();

      connection.on('PlayerEntered', (player) => addPlayerToList(player));
      connection.on('PlayerLeft', (player) => {
        $(`#${player.playerId}`).remove()
      })

      connection.on('Enqueued', () => {
        console.log('enqueued')
        $("#search-field").show()
      });
      connection.on('EnqueueFailed', () => {
        console.log('enqueue failed')
        $("#search-button").show()
        $("#search-field").hide()
      })
      connection.on('MatchFound', (res) => {
        console.log('match found')
        const player1Slot = $('<div>')
        let team1 = res.teams[0];
        let playerId1 = team1.playerIds[0];
        const player1 = players.find(p => p.playerId === playerId1)
        player1Slot.text(`${player1.externalPlayerId} (${team1.mmr.rating} MMR)`)
        $("#game-found").append(player1Slot)
        const vsSlot = $('<div>')
        vsSlot.text("VS")
        $("#game-found").append(vsSlot)

        const player2Slot = $('<div>')
        let team2 = res.teams[1];
        let playerId2 = team2.playerIds[0];
        const player2 = players.find(p => p.playerId === playerId2)
        player2Slot.text(`${player2.externalPlayerId} (${team2.mmr.rating} MMR)`)
        $("#game-found").append(player2Slot)

        $("#game-found").show()
        $("#start-game").show()
        $("#online-player-list").hide()
        $("#search-field").hide()
      });
      connection.on('LoggedIn', (res) => {
        $("#logout-button").show()
        $("#search-button").show()
        res.onlinePlayers.forEach(p => {
          addPlayerToList(p);
        })
      });

      connection.start().then(() => {
        $("#search-button").click(() => {
          $("#search-button").hide()
          connection.invoke(
            'Enqueue',
            {
              queueId: '60968c43e98195000717caa0',
              playerIds: [{playerId: loggedInPlayer.playerId}]
            },
          );
        })

        $("#click-target").click(() => {
          moveClickTargetToRandomPlace();
          clickCounter++

          if (clickCounter > 5) {
            clickCounter = 0;
            $("#click-target").hide()

            const gameEnd = performance.now()
            const diff = gameEnd - gameStart
            $("#waiting-for-game-end").show()

            connection.invoke('ReportGame', diff)
          }
        })

        $("#logout-button").click(() => {
          localStorage.removeItem("player")
          $("#player-name").text("")
          $("#logout-button").hide()
          $("#game").hide()
          $("#player-select-list").show()
        })

        $("#start-game").click(() => {
          $("#start-game").hide()
          $("#click-target").show()
          gameStart = performance.now()

          moveClickTargetToRandomPlace();
        })

        if (loggedInPlayer) {
          connection.invoke(
            'LoginAs',
            loggedInPlayer,
          );
        }
      })

      axios.get(`${matchboxurl}/players?api_key=secret`)
        .then((r => {
          players = r.data
          players.forEach(p => {
            const playerSlot = $('<div>')
            playerSlot.text(`${p.externalPlayerId}`)
            playerSlot.attr("id", p.playerId)
            playerSlot.addClass('player-list-item')
            playerSlot.click((e) => {
              $("#create-player").disabled = true

              loggedInPlayer = {
                playerId: e.target.id,
                externalPlayerId: e.target.innerText,
              }
              localStorage.setItem("player", JSON.stringify(loggedInPlayer))
              logInPlayer(p)
              connection.invoke('LoginAs', loggedInPlayer)
            })
            $('#player-select-list').append(playerSlot)
          })
      }))
    })
  </script>
  <style>
    body {
      font-family: Tahoma, sans-serif;
    }

    .primary-button {
      border-radius: 4px;
      padding: 10px 20px 10px 20px;
      border: 1px solid darkgray;
      background-color: lightgray;
      margin: 20px;
    }

    #game {
      width: 100%;
      text-align: center;
      display: flex;
      justify-content: center;
    }

    #game-found {
      margin-top: 20px;
      margin-bottom: 20px;
    }

    #game-found-header {
      margin-bottom: 10px;
    }

    #click-target {
      position: absolute;
      z-index: 5000;
    }

    .player-list-item {
      border-top: 1px solid darkgray;
      padding: 10px 20px 10px 20px;
    }

    .player-list-item:nth-child(1) {
      border-top: none;
      margin-top: 20px;
    }

  </style>
</head>
<body>
  <div id="click-target" class="primary-button" hidden>
    Click me!
  </div>
  <div id="game" hidden>
    <div id="player-name">
    </div>
    <div id="search-button" class="primary-button" hidden>
      Search Game
    </div>
    <div id="logout-button" class="primary-button" hidden>
      Logout
    </div>
    <div id="start-game" class="primary-button" hidden>
      Start Game
    </div>
    <div id="search-field" hidden>
      Searching Opponent...
    </div>
    <div id="waiting-for-game-end" hidden>
      Waiting for Opponent...
    </div>
    <div id="game-found" hidden>
      <div id="game-found-header">Found Game:</div>
    </div>
    <div id="online-player-list">
      <div>Players online:</div>
      <div id="online-players"></div>
    </div>
  </div>
  <div id="player-select-list">
    <div>Select Player</div>
  </div>
</body>
</html>
