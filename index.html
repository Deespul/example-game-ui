<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clickbait</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.7/signalr.min.js"></script>
  <script>
    function addPlayerToList(p) {
      const playerSlot = $('<div>')
      playerSlot.text(`${p.externalPlayerId}`)
      playerSlot.attr("id", p.playerId)
      $('#online-players').append(playerSlot)
    }

    $(document).ready(() => {
      let nameWasAdded = false
      let playerName = ''
      let loggedInPlayer = JSON.parse(localStorage.getItem("player"))

      if (loggedInPlayer) {
        $("#search-button").show()
        $("#player-name-edit").hide()
        $("#player-name").text(`logged in as: ${loggedInPlayer.externalPlayerId}`)
      }

      $("#create-player").click(() => {
        nameWasAdded = true
        playerName =  $("#name-input").val()
        $("#create-player").disabled = true

        axios.post('https://matchbox.test.w3champions.com/players?api_key=secret', {
          externalPlayerId: playerName
        }).then((r => {
          loggedInPlayer = r.data
          localStorage.setItem("player", JSON.stringify(loggedInPlayer))
          $("#player-name").text(`logged in as: ${loggedInPlayer.externalPlayerId} (${loggedInPlayer.playerId})`)
          $("#search-button").show()
          $("#player-name-edit").hide()
          connection.invoke(
            'LoginAs',
            loggedInPlayer,
          );
        }))
      })

      const hub = 'https://matchbox.example.backend.w3champions.com'
      // const hub = 'http://localhost:5000'

      const connection = new signalR.HubConnectionBuilder()
        .withUrl(`${hub}/gamehub`)
        .build();

      connection.on('PlayerEntered', (player) => addPlayerToList(player));
      connection.on('PlayerLeft', (player) => {
        $(`#${player.playerId}`).remove()
      })

      connection.on('Enqueued', () => {
        console.log('enqueued')
        $("#create-player").disable()
      });
      connection.on('EnqueueFailed', () => {
        console.log('enqueue failed')
        $("#create-player").enable()
      })
      connection.on('MatchFound', () => {
        console.log('match found')
        $("#create-player").hide()
      });
      connection.on('LoggedIn', (res) => {
        res.onlinePlayers.forEach(p => {
          addPlayerToList(p);
        })
      });

      connection.start().then(() => {
        $("#search-button").click(() => {
          connection.invoke(
            'Enqueue',
            {
              queueId: '60968c43e98195000717caa0',
              playerIds: [{playerId: loggedInPlayer.playerId}]
            },
          );
        })

        if (loggedInPlayer) {
          connection.invoke(
            'LoginAs',
            loggedInPlayer,
          );
        }
      })
    })
  </script>
</head>
<body>
<div id="player-name">
</div>
<button id="search-button" hidden>
  Search Game
</button>
<div>
  <div>Players online</div>
  <div id="online-players"></div>
</div>
<div id="player-name-edit">
  <label for="name-input">Enter your name:</label>
  <input type="text" id="name-input">
  <button id="create-player">
    Save Name
  </button>
</div>

</body>
</html>
