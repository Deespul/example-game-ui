<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clickbait</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.7/signalr.min.js"></script>
  <script src="./env.js"></script>
  <script>
    const apiurl = config.API_URL
    const matchboxurl = config.MATCHBOX_API

    function addPlayerToList(p) {
      const playerSlot = $('<div>')
      playerSlot.text(`${p.externalPlayerId}`)
      playerSlot.attr("id", p.playerId)
      playerSlot.addClass('player-list-item')
      $('#online-players').append(playerSlot)
    }

    function logInPlayer(loggedInPlayer) {
      $("#game").show()
      $("#player-select-list").remove()
      $("#player-name").text(`logged in as: ${loggedInPlayer.externalPlayerId}`)
    }

    $(document).ready(() => {
      let loggedInPlayer = JSON.parse(localStorage.getItem("player"))
      let players = []

      if (loggedInPlayer) {
        logInPlayer(loggedInPlayer);
      }

      const connection = new signalR.HubConnectionBuilder()
        .withUrl(`${apiurl}/gamehub`)
        .build();

      connection.on('PlayerEntered', (player) => addPlayerToList(player));
      connection.on('PlayerLeft', (player) => {
        $(`#${player.playerId}`).remove()
      })

      connection.on('Enqueued', () => {
        console.log('enqueued')
      });
      connection.on('EnqueueFailed', () => {
        console.log('enqueue failed')
      })
      connection.on('MatchFound', (res) => {
        $("#search-button").hide()

        const player1Slot = $('<div>')
        let team1 = res.teams[0];
        let playerId1 = team1.playerIds[0];
        const player1 = players.find(p => p.playerId === playerId1)
        player1Slot.text(`${player1.externalPlayerId} (${team1.mmr.rating} MMR)`)
        $("#game-found").append(player1Slot)
        const vsSlot = $('<div>')
        vsSlot.text("VS")
        $("#game-found").append(vsSlot)

        const player2Slot = $('<div>')
        let team2 = res.teams[1];
        let playerId2 = team2.playerIds[0];
        const player2 = players.find(p => p.playerId === playerId2)
        player2Slot.text(`${player2.externalPlayerId} (${team2.mmr.rating} MMR)`)
        $("#game-found").append(player2Slot)

        $("#game-found").show()

        console.log('match found')
      });
      connection.on('LoggedIn', (res) => {
        res.onlinePlayers.forEach(p => {
          addPlayerToList(p);
        })
      });

      connection.start().then(() => {
        $("#search-button").click(() => {
          connection.invoke(
            'Enqueue',
            {
              queueId: '60968c43e98195000717caa0',
              playerIds: [{playerId: loggedInPlayer.playerId}]
            },
          );
        })

        if (loggedInPlayer) {
          connection.invoke(
            'LoginAs',
            loggedInPlayer,
          );
        }
      })


      axios.get(`${matchboxurl}/players?api_key=secret`)
        .then((r => {
          players = r.data
          players.forEach(p => {
            const playerSlot = $('<div>')
            playerSlot.text(`${p.externalPlayerId}`)
            playerSlot.attr("id", p.playerId)
            playerSlot.addClass('player-list-item')
            playerSlot.click((e) => {
              $("#create-player").disabled = true

              loggedInPlayer = {
                playerId: e.target.id,
                externalPlayerId: e.target.innerText,
              }
              localStorage.setItem("player", JSON.stringify(loggedInPlayer))
              logInPlayer(p)
              connection.invoke('LoginAs', loggedInPlayer)
            })
            $('#player-select-list').append(playerSlot)
          })
      }))
    })
  </script>
  <style>
    body {
      display: flex;
      justify-content: center;
      font-family: Tahoma, sans-serif;
      text-align: center;
    }

    #search-button {
      border-radius: 4px;
      padding: 10px 20px 10px 20px;
      border: 1px solid darkgray;
      background-color: lightgray;
      margin: 20px;
    }

    #game-found {
      margin-top: 20px;
      margin-bottom: 20px;
    }

    #game-found-header{
      margin-bottom: 10px;
    }

    .player-list-item {
      border-top: 1px solid darkgray;
      padding: 10px 20px 10px 20px;
    }

    .player-list-item:nth-child(1) {
      border-top: none;
      margin-top: 20px;
    }

  </style>
</head>
<body>
<div id="game" hidden>
  <div id="player-name">
  </div>
  <div id="search-button">
    Search Game
  </div>
  <div id="game-found" hidden>
    <div id="game-found-header">Found Game:</div>
  </div>
  <div>
    <div>Players online:</div>
    <div id="online-players"></div>
  </div>
</div>
<div id="player-select-list">
  <div>Select Player</div>
</div>

</body>
</html>
